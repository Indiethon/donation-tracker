<!DOCTYPE html>
<html>

<head>
    <script src="/content/pages/dashboard/utils.js"></script>
</head>

<body onLoad="load()">
    <div id="header">
        <button id="back"
            onclick="switchPage('/content/pages/dashboard/admin/tracker/events/events.html')">&lt;</button>
        <div id="type">List</div>
    </div>
    <div id="content">
        <form>
            <div id="name" class="inputDiv">
                <label class="label">Name</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="short" class="inputDiv">
                <label class="label">Short</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="description" class="inputDiv">
                <label class="label">Description</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="hashtag" class="inputDiv">
                <label class="label">Hashtag</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="charity" class="inputDiv">
                <label class="label">Charity</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="currency" class="inputDiv">
                <label class="label">Currency</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="targetAmount" class="inputDiv">
                <label class="label">Target Amount</label>
                <input class="input" type="number">
                <span class="errorText"></span>
            </div>
            <div id="minDonation" class="inputDiv">
                <label class="label">Minimum Donation</label>
                <input class="input" type="number">
                <span class="errorText"></span>
            </div>
            <div id="autoScreen" class="inputDiv">
                <label class="label">Donation Auto-Screen</label>
                <input class="input" type="checkbox">
                <span class="errorText"></span>
            </div>
            <div id="timezone" class="inputDiv">
                <label class="label">Timezone</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="startTime" class="inputDiv">
                <label class="label">Start Time</label>
                <input class="input" type="datetime-local">
                <span class="errorText"></span>
            </div>
            <div id="endTime" class="inputDiv">
                <label class="label">End Time</label>
                <input class="input" type="datetime-local">
                <span class="errorText"></span>
            </div>
            <div id="prizeTime" class="inputDiv">
                <label class="label">Prize Draw Time</label>
                <input class="input" type="datetime-local">
                <span class="errorText"></span>
            </div>
            <div id="visible" class="inputDiv">
                <label class="label">Visible</label>
                <input class="input" type="checkbox">
                <span class="errorText"></span>
            </div>
            <div id="active" class="inputDiv">
                <label class="label">Active</label>
                <input class="input" type="checkbox">
                <span class="errorText"></span>
            </div>
        </form>
        <button id="create" onClick="submit()">Save</button>
    </div>

    <script>
        function load() {
            const urlParams = new URLSearchParams(window.location.search);
            GET(`events/${urlParams.get('event')}`, (err, data) => {
                if (err) return;
                document.querySelector('#name input').value = data.data.name;
                document.querySelector('#short input').value = data.data.short;
                document.querySelector('#description input').value = data.data.description;
                document.querySelector('#hashtag input').value = data.data.hashtag;
                document.querySelector('#charity input').value = data.data.charityId;
                document.querySelector('#currency input').value = data.data.currency;
                document.querySelector('#targetAmount input').value = data.data.targetAmount;
                document.querySelector('#minDonation input').value = data.data.minDonation;
                document.querySelector('#autoScreen input').checked = data.data.autoScreen;
                document.querySelector('#timezone input').value = data.data.timezone;
                document.querySelector('#startTime input').value = data.data.startTime.split('.')[0]
                document.querySelector('#endTime input').value = data.data.endTime.split('.')[0]
                document.querySelector('#prizeTime input').value = (data.data.prizeTime !== null && data.data.prizeTime !== undefined) ? data.data.prizeTime.split('.')[0]: ""
                document.querySelector('#visible input').checked = data.data.visible;
                document.querySelector('#active input').checked = data.data.active;
                console.log(data.data.active)
            })
        }

        function submit() {
            let options = {};
            let startTime, endTime, prizeTime;
            try { startTime = new Date(document.querySelector('#startTime input').value).toISOString() } catch { startTime = document.querySelector('#startTime input').value }
            try { endTime = new Date(document.querySelector('#endTime input').value).toISOString() } catch { endTime = document.querySelector('#endTime input').value }
            try { prizeTime = new Date(document.querySelector('#prizeTime input').value).toISOString() } catch { prizeTime = "" }
            options.name = document.querySelector('#name input').value;
            options.short = document.querySelector('#short input').value;
            options.description = document.querySelector('#description input').value;
            options.hashtag = document.querySelector('#hashtag input').value;
            options.charity = document.querySelector('#charity input').value;
            options.currency = document.querySelector('#currency input').value;
            options.targetAmount = +parseFloat(document.querySelector('#targetAmount input').value).toFixed(2);
            options.minDonation = +parseFloat(document.querySelector('#minDonation input').value).toFixed(2);
            options.autoScreen = document.querySelector('#autoScreen input').checked;
            options.timezone = document.querySelector('#timezone input').value;
            options.startTime = startTime;
            options.endTime = endTime;
            options.prizeTime = prizeTime;
            options.visible = document.querySelector('#visible input').checked;
            options.active = document.querySelector('#active input').checked;

            let elementList = document.querySelectorAll('.inputDiv');
            [...elementList].forEach(element => {
                let el = document.querySelector(`#${element.id} span`)
                el.innerHTML = '';
                el.style.visibility = 'none';
            });

            POST('events/update', options, (err, data) => {
                if (!err) {
                    showPopup('success', `Event ${options.name} created successfully.`)
                    switchPage('/content/pages/dashboard/admin/tracker/events/events.html')
                    return;
                }

                data.data.errorCodes.forEach(error => {
                    let element = document.querySelector(`#${error.item} span`);
                    element.innerHTML = error.code;
                    element.style.visibility = 'inherit';
                })
                showPopup('error', `Validation errors found, please resolve them.`)
            })
        }
    </script>
    <style>
        .errorText {
            color: red;
        }
    </style>
</body>

</html>