<!DOCTYPE html>
<html>

<head>
    <script src="/content/pages/dashboard/utils.js"></script>
    <link rel="stylesheet" href="/content/pages/dashboard/admin/common.css" />
</head>

<body onLoad="load(false)">
    <script>let model = 'speedruns';</script>
    <datalist id='runnerDatalist'></datalist>
    <ul class="breadcrumb">
        <li><a onClick="switchPage(`/content/pages/dashboard/admin/home.html`)">Home</a></li>
        <li><a
                onClick="switchPage(`/content/pages/dashboard/admin/eventPages/${model}/${model}.html?event=${urlParams.get('event')}`)">Speedruns</a>
        </li>
        <li><a onClick="location.reload()">Edit</a>
        </li>
    </ul>
    <div class="header">
        <div class="editHeader">
            <button class="editBack"
                onClick="switchPage(`/content/pages/dashboard/admin/eventPages/${model}/${model}.html?event=${urlParams.get('event')}`)">&lt;</button>
            <h2 class="title"></h2>
        </div>
    </div>
    <div class="loadingContent">
        <div class="loadingAnimation">
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <div class="content">
        <form>
            <div id="id" class="inputDiv">
                <label class="label">ID</label>
                <input class="input" disabled>
                <span class="errorText"></span>
            </div>
            <div id="game" class="inputDiv">
                <label class="label">Game</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="category" class="inputDiv">
                <label class="label">Category</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="runners" class="arrayInputDiv">
                <label class="label">Runners</label>
                <div class="arrayInputContainer">
                    <div class="arrayInput">

                    </div>
                    <button type="button" class="arrayAddButton"
                        onClick="addArrayElement(document.querySelector(`#runners .arrayInput`), '')">Add New
                        Item</button>
                </div>
                <span class="errorText"></span>
            </div>
            <div id="description" class="inputDiv">
                <label class="label">Description</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="releaseYear" class="inputDiv">
                <label class="label">Release Year</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="console" class="inputDiv">
                <label class="label">Console</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="startTime" class="inputDiv">
                <label class="label">Start Time</label>
                <input class="input" type="datetime-local">
                <span class="errorText"></span>
            </div>
            <div id="estimate" class="inputDiv">
                <label class="label">Estimate</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="finalTime" class="inputDiv">
                <label class="label">Final Time</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="finalSetupTime" class="inputDiv">
                <label class="label">Final Setup Time</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
            <div id="notes" class="inputDiv">
                <label class="label">Notes</label>
                <input class="input">
                <span class="errorText"></span>
            </div>
        </form>
        <button id="submit" onClick="submit()"></button>
        <div></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let runnerList;

        function pageLoaded() {
            showBody();
            fetchRunners();
            try {
                switch (urlParams.get('type')) {
                    case 'create': create(); break;
                    case 'edit': edit(urlParams.get('id')); break;
                    case 'view': view(urlParams.get('id')); break;
                    default:
                        showToast('error', `Error opening page. Please contact the system administrator.`)
                        switchPage(`/content/pages/dashboard/admin/eventPages/${model}/${model}.html?event=${urlParams.get('event')}`)
                }
            } catch (e) {
                console.error(e)
                showToast('error', `Error opening page. Please contact the system administrator.`)
                switchPage(`/content/pages/dashboard/admin/eventPages/${model}/${model}.html?event=${urlParams.get('event')}`)
            }
        }

        function fetchRunners() {
            GET('runners', (err, data) => {
                if (err) return;
                runnerList = data.data;
                let runnerDatalist = document.getElementById('runnerDatalist');
                if (data.data.length <= 0) {
                    showToast('error', `There are no saved runners. Please add a runner before continuing.`)
                    switchPage(`/content/pages/dashboard/admin/${model}/${model}.html`)
                    return;
                }
                for (const runner of data.data) {
                    runnerDatalist.innerHTML += `<option runner="${runner.id}" value="${runner.name}">ID: ${runner._id}</option>`;
                }
            })
        }

        function fetchData(event, callback) {
            GET(`speedruns/${urlParams.get('id')}`, (err, data) => {
                if (err) return;
                document.querySelector('#id input').value = data.data.id;
                document.querySelector('#game input').value = data.data.game;
                document.querySelector('#category input').value = data.data.category;
                document.querySelector('#description input').value = data.data.description;
                document.querySelector('#startTime input').value = data.data.startTime.split('.')[0];
                document.querySelector('#estimate input').value = data.data.estimate;
                document.querySelector('#finalTime input').value = data.data.finalTime;
                document.querySelector('#finalSetupTime input').value = data.data.finalSetupTime;
                document.querySelector('#releaseYear input').value = data.data.releaseYear;
                document.querySelector('#console input').value = data.data.console;
                document.querySelector('#notes input').value = data.data.notes;
                for (const runner of data.data.runners) {
                    addArrayElement(document.querySelector(`#runners .arrayInput`), runner.name)
                }
                callback();
            })
        }

        function create() {
            document.querySelector('#id').style.display = 'none';
            document.querySelector('.title').innerHTML = 'Create Speedrun';
            document.getElementById('submit').innerHTML = 'Create';
            showContent();
        }

        function edit(speedrun) {
            fetchData(speedrun, () => {
                document.querySelector('.title').innerHTML = 'Edit Speedrun';
                document.getElementById('submit').innerHTML = 'Save';
                showContent();
            })
        }
        function view(speedrun) {
            fetchData(speedrun, () => {
                document.querySelector('#game input').disabled = true;
                document.querySelector('#category input').disabled = true;
                document.querySelector('#runners input').disabled = true;
                document.querySelector('#description input').disabled = true;
                document.querySelector('#startTime input').disabled = true;
                document.querySelector('#estimate input').disabled = true;
                document.querySelector('#finalTime input').disabled = true;
                document.querySelector('#finalSetupTime input').disabled = true;
                document.querySelector('#releaseYear input').disabled = true;
                document.querySelector('#console input').disabled = true;
                document.querySelector('#notes input').disabled = true;
                document.getElementById('submit').style.display = 'none';
                document.querySelector('.title').innerHTML = 'View Speedrun';
                for (const input of document.querySelectorAll('.arrayInput div')) {
                    input.querySelector('input').disabled = true;
                    try { input.querySelector('button').style.display = 'none' } catch {}
                }
                document.querySelector('.arrayAddButton').style.display = 'none'
                showContent();
            })
        }

        function submit() {
            let options = {};
            options.eventId = urlParams.get('event');
            options.game = document.querySelector('#game input').value;
            options.category = document.querySelector('#category input').value;
            options.description = document.querySelector('#description input').value;
            options.startTime = document.querySelector('#startTime input').value;
            options.estimate = document.querySelector('#estimate input').value;
            options.finalTime = document.querySelector('#finalTime input').value;
            options.finalSetupTime = document.querySelector('#finalSetupTime input').value;
            options.releaseYear = document.querySelector('#releaseYear input').value;
            options.console = document.querySelector('#console input').value;
            options.notes = document.querySelector('#notes input').value;
            options.runners = [];
            for (const input of document.querySelectorAll('.arrayInputDivChild')) {
                try { options.runners.push(runnerList.find(el => el.name === input.querySelector('input').value)._id); } catch { options.runners.push('') };
            }
            if (options.runners.length > 1) options.multiplayer = true;

            let elementList = document.querySelectorAll('.inputDiv');
            [...elementList].forEach(element => {
                let el = document.querySelector(`#${element.id} span`)
                el.innerHTML = '';
                el.style.visibility = 'hidden';
            });

            POST(`speedruns${(urlParams.get('type') === 'create') ? '' : `/${urlParams.get('id')}`}`, options, (err, data) => {
                if (!err) {
                    showToast('success', `Speedrun updated successfully.`)
                    switchPage(`/content/pages/dashboard/admin/eventPages/${model}/${model}.html?event=${urlParams.get('event')}`)
                    return;
                }

                data.data.errorCodes.forEach(error => {
                    let element = document.querySelector(`#${error.item.split('.')[0]} span`);
                    element.innerHTML = error.code;
                    element.style.visibility = 'inherit';
                })
                showToast('error', `Validation errors found, please resolve them.`)
            })
        }

        function addArrayElement(div, value) {

            let runner = document.createElement('div');
            runner.setAttribute('class', 'arrayInputDivChild')

            let label = document.createElement('label');
            label.setAttribute('class', 'label')
            label.innerHTML = 'Runner';

            let input = document.createElement('input');
            input.setAttribute('class', 'input');
            input.setAttribute('list', 'runnerDatalist')
            input.value = value;

            runner.appendChild(label);
            runner.appendChild(input)

            let button = document.createElement('button');
            button.setAttribute('type', 'button');
            button.setAttribute('class', 'deleteButton material-icons');
            button.setAttribute('onClick', 'this.parentNode.remove()');
            button.innerHTML = 'delete_forever';

            let divDiv = document.createElement('div');

            divDiv.appendChild(runner);
            divDiv.appendChild(button);
            div.appendChild(divDiv)
        }
    </script>
</body>

</html>