<!DOCTYPE html>
<html>

<head>
    <script src="/content/pages/dashboard/utils.js"></script>
    <link rel="stylesheet" href="/content/pages/dashboard/common.css" />
</head>

<body>
    <script>
        let model = 'drawPrizes';
        const urlParams = new URLSearchParams(window.location.search);
    </script>
    <ul class="breadcrumb">
        <li><a onClick="switchPage(`/content/pages/dashboard/admin/home/home.html`)">Home</a></li>
        <li><a onClick="switchPage(`/content/pages/dashboard/admin/${model}/${model}.html`)">Draw Prizes</a>
        </li>
    </ul>
    <div class="header">
        <div class="editHeader">
            <button class="editBack" onClick="switchPage(`/content/pages/dashboard/admin/home/home.html`)">&lt;</button>
            <h2 class="title"></h2>
            <button class="helpButton"
                onClick="window.open('https://github.com/Indiethon/donation-tracker/blob/main/docs/prizes/Drawing%20Prizes.md', '_blank')">Help</button>
        </div>
    </div>
    <div class="loadingContent">
        <div class="loadingAnimation">
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <div class="content">
        <datalist id="prizeDatalist"></datalist>
        <datalist id="donorDatalist"></datalist>
        <form id="drawPrizesForm">
            <div id="event" class="inputDiv">
                <label class="label">Event<span class="required"> ✱</span></label>
                <select class="select" id="eventSelect" onChange="updatePrizes(this.value)"></select>
                <span class="errorText"></span>
            </div>
            <div id="entryType" class="inputDiv">
                <label class="label">Entry Type<span class="required"> ✱</span></label>
                <select class="select" id="prizeSelect">
                    <option value="single">Single Entry</option>
                    <option value="multi">Multi Entry</option>
                </select>
                <span class="errorText"></span>
            </div>
            <div id="prizes" class="inputDiv">
                <label class="label">Prizes<span class="required"> ✱</span></label>
                <select class="select" id="prizeSelect" onChange="displayPrizeArray(this.value)">
                    <option value="all">All</option>
                    <option value="expired">Unredeemed</option>
                    <option value="custom">Custom</option>
                </select>
                <span class="errorText"></span>
                <div class="array container">
                    <div class="array div">

                    </div><button type="button" class="array addButton" onClick="addNewArrayItem('prizes')">New
                        Item</button>
                </div><span class="errorText"></span>
            </div>
            <div id="additionalEntrants" class="arrayInputDiv">
                <label class="label">Additional Entrants</label>
                <div class="array container">
                    <div class="array div">

                    </div><button type="button" class="array addButton"
                        onClick="addNewArrayItem('additionalEntrants')">New
                        Item</button>
                </div><span class="errorText"></span>
            </div>
        </form>
        <form id="drawStatusForm" style="display: none">
            <div id="drawStatus" class="inputDiv">
                <label class="label">Draw Status</label>
                <textarea class="textarea" id="drawStatusTextarea" disabled></textarea>
                <span class="errorText"></span>
            </div>
        </form>

        <button id="submit" onClick="submit()"></button>
        <div></div>
    </div>

    <script>
        load(false, { model: 'drawPrizes', level: 'full' });
        // setBreadcrumb(urlParams.get('event'));

        async function pageLoaded() {
            let eventSelect = document.querySelector('#eventSelect');
            let events = await GET('events');
            events.data.forEach(event => eventSelect.innerHTML = eventSelect.innerHTML + `<option value="${event._id}">${event.name}</option>`);

            let datalistData2 = await GET(`donors`);
            for (const item of datalistData2.data) {
                document.querySelector('#donorDatalist').innerHTML += `<option dataId="${item._id}" value="${item.email}">ID: ${item._id}</option>`
            }

            await updatePrizes(document.querySelector('#event select').value)
            showBody();
            document.querySelector('.title').innerHTML = 'Draw Prizes';
            document.getElementById('submit').innerHTML = 'Continue';
            showContent();
        }

        async function updatePrizes(value) {
            let datalistData1 = await GET(`prizes?event=${value}`);
            document.querySelector('#prizeDatalist').innerHTML = '';
            for (const item of datalistData1.data) {
                document.querySelector('#prizeDatalist').innerHTML += `<option dataId="${item._id}" value="${item.name}">ID: ${item._id}</option>`
            }
            document.querySelector('#prizes .array.div').innerHTML = '';
            document.querySelector('#additionalEntrants .array.div').innerHTML = '';
            return;
        }

        function displayPrizeArray(value) {
            if (value === 'custom') return document.querySelector('#prizes .array.container').style.display = 'inherit';
            return document.querySelector('#prizes .array.container').style.display = 'none';
        }

        function addNewArrayItem(group) {
            let labelName;
            let datalistName;
            switch (true) {
                case (group === 'prizes'): labelName = 'Prize'; break;
                case (group === 'additionalEntrants'): labelName = 'Donor'; break;
            }
            switch (true) {
                case (group === 'prizes'): datalistName = 'prizeDatalist'; break;
                case (group === 'additionalEntrants'): datalistName = 'donorDatalist'; break;
            }
            let outerDiv = document.createElement('div');
            outerDiv.setAttribute('class', 'array childDiv');

            let div1 = document.createElement('div');

            let label1 = document.createElement('label');
            label1.setAttribute('class', 'label');
            label1.innerHTML = labelName;

            let input1 = document.createElement('input');
            input1.setAttribute('class', 'input');
            input1.setAttribute('type', 'input');
            input1.setAttribute('list', datalistName);

            let button = document.createElement('button');
            button.setAttribute('class', 'array deleteButton material-icons-outlined');
            button.setAttribute('type', 'button');
            button.setAttribute('onClick', 'this.parentNode.remove()')
            button.innerHTML = 'delete_forever';

            div1.append(label1, input1);

            if (group === 'additionalEntrants') {
                let div2 = document.createElement('div');

                let label2 = document.createElement('label');
                label2.setAttribute('class', 'label');
                label2.innerHTML = 'Prize';

                let input2 = document.createElement('input');
                input2.setAttribute('class', 'input');
                input2.setAttribute('type', 'input');
                input2.setAttribute('list', 'prizeDatalist');

                div2.append(label2, input2)
                outerDiv.append(div1, div2, button)
            } else {
                outerDiv.append(div1, button)
            }

            document.querySelector(`#${group} .array.div`).append(outerDiv)
        }

        async function submit() {
            let data = {};
            let prizes = [];
            let additionalEntrants = {};

            let prizeDatalist = document.querySelectorAll('#prizeDatalist option');
            let donorDatalist = document.querySelectorAll('#donorDatalist option');

            if (document.querySelector('#prizes select').value === 'all') {
                let options = document.querySelectorAll('#prizeDatalist option');
                for (let option of options) {
                    prizes.push(option.getAttribute('dataId'));
                }
            }
            else {
                let fields = document.querySelectorAll('#prizes .array.childDiv input');
                for (const field of fields) {
                    for (const option of prizeDatalist) {
                        if (option.getAttribute('value') === field.value) prizes.push(option.getAttribute('dataId'));
                    }
                }
            }

            let nameFields = document.querySelectorAll('#additionalEntrants .array.childDiv');
            for (const field of nameFields) {
                let inputs = field.querySelectorAll('input')
                for (const donorOption of donorDatalist) {
                    if (donorOption.getAttribute('value') === inputs[0].value) {
                        for (const option of prizeDatalist) {
                            if (option.getAttribute('value') === inputs[1].value) {
                                if (additionalEntrants[donorOption.getAttribute('dataId')] === undefined) additionalEntrants[donorOption.getAttribute('dataId')] = [option.getAttribute('dataId')];
                                else additionalEntrants[donorOption.getAttribute('dataId')].push(option.getAttribute('dataId'))
                            }
                        }
                        break;
                    }
                }
            }

            // let fields = value.querySelectorAll('.array.childDiv');
            //             let data = [];
            //             for (const field of fields) {
            //                 let inputs = field.querySelectorAll('select');
            //                 data.push({
            //                     model: inputs[0].value,
            //                     level: inputs[1].value,
            //                 })
            //             }

            data.event = document.querySelector('#event select').value;
            data.entryType = (document.querySelector('#entryType select').value === 'single') ? 'single' : 'multi';
            data.prizes = prizes;
            data.additionalEntrants = additionalEntrants;
            if (document.querySelector('#prizes select').value === 'expired') data.expired = true;

            let prizeDrawData = await POST('drawPrizes', data);

            document.querySelector('#drawStatusTextarea').value = prizeDrawData.data.message;
            document.querySelector('#drawPrizesForm').style.display = 'none'
            document.querySelector('#drawStatusForm').style.display = 'block'
            document.getElementById('submit').innerHTML = 'Finish';
            document.getElementById('submit').setAttribute('onClick', 'switchPage(`/content/pages/dashboard/admin/home/home.html`)');
            showToast('success', `Prize draw completed!`)
        }
    </script>
    <style>
        #prizes .array.container {
            display: none;
        }
    </style>

</body>

</html>